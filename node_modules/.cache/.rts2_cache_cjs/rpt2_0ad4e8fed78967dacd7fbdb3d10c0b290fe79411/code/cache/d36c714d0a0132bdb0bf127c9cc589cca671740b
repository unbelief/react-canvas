{"code":"import React, { useEffect, useRef, createContext, useReducer, useContext, } from \"react\";\r\nconst initialState = {\r\n    devicePixelRatio: 1,\r\n    canvas: null,\r\n    context: null,\r\n    events: [],\r\n    shapes: new Set(),\r\n};\r\nconst reducer = (state, action) => {\r\n    switch (action.type) {\r\n        case \"initialize\":\r\n            return Object.assign(state, action.state);\r\n        case \"update:shape\":\r\n            return {\r\n                ...state,\r\n                events: [...state.events, action.body.type],\r\n                shapes: state.shapes.add(action.body),\r\n            };\r\n        default:\r\n            return state;\r\n    }\r\n};\r\nconst context = createContext({});\r\n/**\r\n * provider\r\n * @param {Function} props\r\n * @param {Object} attributes\r\n * @param {Array} event\r\n */\r\nconst Scene = (props) => {\r\n    const [state, dispatch] = useReducer(reducer, initialState);\r\n    return (React.createElement(context.Provider, { value: { state, dispatch } },\r\n        React.createElement(Stage, Object.assign({}, props)),\r\n        props.children));\r\n};\r\n/**\r\n * createCanvas\r\n * @param {object} props\r\n * @param {json} attributes\r\n */\r\nconst Stage = (props) => {\r\n    const { state, dispatch } = useContext(context);\r\n    const stageRef = useRef(null);\r\n    const attributes = (props.attribute || {});\r\n    useEffect(() => {\r\n        const canvas = stageRef.current;\r\n        const devicePixelRatio = window.devicePixelRatio || 1;\r\n        canvas.width = ~~canvas.clientWidth * devicePixelRatio;\r\n        canvas.height = ~~canvas.clientHeight * devicePixelRatio;\r\n        const context = canvas.getContext(\"2d\");\r\n        const state = { devicePixelRatio, canvas, context };\r\n        dispatch({ type: \"initialize\", state: state });\r\n    }, []);\r\n    useEffect(() => {\r\n        state.events.forEach((type) => {\r\n            state.canvas.addEventListener(type, stageHandle);\r\n        });\r\n        return () => {\r\n            state.events.forEach((type) => {\r\n                state.canvas.removeEventListener(type, stageHandle);\r\n            });\r\n        };\r\n    }, [state.events]);\r\n    function stageHandle(e) {\r\n        const node = e.target;\r\n        const { left, top } = node.getBoundingClientRect();\r\n        let originalX, originalY;\r\n        const evtArgs = {\r\n            originalEvent: e,\r\n            type: event,\r\n        };\r\n        if (isTouch(e)) {\r\n            const { clientX, clientY } = e.changedTouches[0];\r\n            originalX = Math.round(clientX - left);\r\n            originalY = Math.round(clientY - top);\r\n        }\r\n        else {\r\n            originalX = Math.round(e.clientX - left);\r\n            originalY = Math.round(e.clientY - top);\r\n        }\r\n        let x, y;\r\n        x = state.devicePixelRatio * originalX;\r\n        y = state.devicePixelRatio * originalY;\r\n        Object.assign(evtArgs, { originalX, originalY }, { x, y });\r\n        state.shapes.forEach((shape) => {\r\n            e.type === shape.type\r\n                ? isInside({ x, y }, shape.rect)\r\n                    ? shape.handle()\r\n                    : 0\r\n                : 0;\r\n        });\r\n        e.preventDefault();\r\n    }\r\n    // function isTouch(\r\n    //   e: React.TouchEvent | React.MouseEvent\r\n    // ): e is React.TouchEvent {\r\n    //   return e.nativeEvent instanceof TouchEvent;\r\n    // }\r\n    function isTouch(e) {\r\n        return e instanceof TouchEvent;\r\n    }\r\n    function isInside(pos, rect) {\r\n        return (pos.x > rect.x &&\r\n            pos.x < rect.x + rect.width &&\r\n            pos.y < rect.y + rect.height &&\r\n            pos.y > rect.y);\r\n    }\r\n    return (React.createElement(\"canvas\", { ref: stageRef, style: attributes, onContextMenu: (e) => {\r\n            e.preventDefault();\r\n        }, onMouseOver: () => {\r\n            const canvas = stageRef.current;\r\n            canvas.style.cursor = \"pointer\";\r\n        }, onMouseOut: () => {\r\n            const canvas = stageRef.current;\r\n            canvas.style.cursor = \"default\";\r\n        } }));\r\n};\r\nexport { Scene, context };\r\n//# sourceMappingURL=scene.js.map","references":["/Users/hhh/coding/react-canvas/node_modules/@types/react/index.d.ts","/Users/hhh/coding/react-canvas/src/adapter/types.ts"],"map":"{\"version\":3,\"file\":\"scene.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/adapter/scene.tsx\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/Users/hhh/coding/react-canvas/adapter/scene.d.ts","writeByteOrderMark":false,"text":"import { FC } from \"react\";\r\nimport { Props } from \"./types\";\r\ndeclare const context: any;\r\n/**\r\n * provider\r\n * @param {Function} props\r\n * @param {Object} attributes\r\n * @param {Array} event\r\n */\r\ndeclare const Scene: FC<Props>;\r\nexport { Scene, context };\r\n"}}
